name: Automated Selenium UI Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  run-selenium-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # Use the built-in system tools rather than separate actions for simplicity and reliability
      - name: Install Dependencies & Setup Browser
        run: |
          # Install Python requirements
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install selenium
          
          # Install Chromedriver and Chrome browser for Selenium
          sudo apt-get update && sudo apt-get install -y chromium-chromedriver chromium-browser
          # Set the path variable so Selenium can find the driver
          echo "PATH=$PATH:/usr/lib/chromium-browser" >> $GITHUB_ENV
          
      # CRITICAL FIX: Start app in background using 0.0.0.0 host
      - name: Start Flask Application (Background)
        run: |
          # Use '&' to run the app in the background. --host 0.0.0.0 is vital for CI.
          python app.py --host 0.0.0.0 &
          sleep 7 # Increased wait time slightly for reliability
          
      # CRITICAL FIX: Make sure the port check and error message are consistent
      - name: Run Flask App Health Check (Port 5005)
        run: |
          # Check the correct port (5005) and show the correct error message if it fails
          curl --fail http://127.0.0.1:5005 || (echo "App not running on 5005" && exit 1)

      - name: Run ALL Team Selenium Tests
        run: |
          echo "== Beginning Tests =="
          
          # Use a loop or separate commands for all test files
          TEST_FILES="Kai_unittests.py"
          
          for test_file in $TEST_FILES; do
            if [ -f "$test_file" ]; then
              echo "--- Running $test_file ---"
              python3 $test_file
              
              if [ $? -ne 0 ]; then
                echo "::error file=$test_file::Selenium tests failed in $test_file."
                exit 1 
              fi
            else
              echo "--- Skipping $test_file (Not Found) ---"
            fi
          done
          
          echo "== Ending Tests =="
