name: Automated Selenium UI Tests

on:
  push:
    branches:
      - main

jobs:
  run-selenium-tests:
    runs-on: ubuntu-latest
    
    # CRITICAL CHANGE: REMOVE THE ENTIRE 'services:' BLOCK!
    # The app will now run in the main 'run-selenium-tests' job.

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install Dependencies & Setup Browser
      run: |
        pip install -r requirements.txt
        pip install selenium
        sudo apt-get update && sudo apt-get install -y chromium-chromedriver chromium-browser
        echo "PATH=$PATH:/usr/lib/chromium-browser" >> $GITHUB_ENV
        
    # NEW STEP: Start the Flask app in the background of THIS job
    - name: Start Flask Application (Background)
      run: |
        # Use '&' to run the app in the background
        # CRITICAL: Flask must be run on host 0.0.0.0 for access within the runner
        python app.py &
        sleep 5 # Wait for the server to spin up
        
        # Health check now uses 127.0.0.1 (since it's running in the same container)
        curl --fail http://127.0.0.1:5005/ || (echo "App not running on 5005" && exit 1)

    - name: Run ALL Team Selenium Tests
      run: |
        # ... (rest of the test running logic remains the same)
        TEST_FILES=$(ls *_unittests.py)
        echo "Found the following test files: $TEST_FILES"
        
        for test_file in $TEST_FILES; do
          echo "--- Running $test_file ---"
          python3 $test_file
          
          if [ $? -ne 0 ]; then
            echo "::error file=$test_file::Selenium tests failed in $test_file."
            exit 1 
          fi
        done
